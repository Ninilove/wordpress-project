## pipeline script
pipeline {
    agent {label 'agent'}
	stages { 
        stage('cloning our code') {
            steps {
                git branch: 'main', url: 'https://github.com/Ninilove/wordpress-project.git'
            }
        }
        stage('Building docker image') {
            steps {
                sh 'docker build -t ngouabounina/wordpress:6.3-php8.2-apache .'
            }
        }
        stage('Push to docker registry') {
            steps {
                sh 'docker push ngouabounina/wordpress:6.3-php8.2-apache'
            }
        }
        stage('Deploying to kubernetes') {
            steps {
                sh """
                      kubectl apply -f mysql-configmap.yml
                      kubectl apply -f mysql-root-credential.yml
                      kubectl apply -f wordpress-configmap.yml
                      kubectl apply -f wordpress-db-credential.yml
                      kubectl apply -f ingress-controller.yml
                      kubectl apply -f mysql-storageclass.yml
                      kubectl apply -f mysql-pv-pvc.yml
                      kubectl apply -f mysql-deployment.yml
                      kubectl apply -f wordpress-deployment.yml
                      kubectl apply -f wordpress-ingress.yml
                      kubectl apply -f wordpress-hpa.yml
                    
                   """
            }
        }
    }
}




########################################################################
#!/bin/bash
# build-and-deploy.sh

# Build the custom WordPress image
docker build -t ngouabounina/wordpress:6.2.1-apache .

# Push to container registry
docker push ngouabounina/wordpress:6.2.1-apache

# Deploy to Kubernetes
kubectl apply -f mysql-secret.yml
kubectl apply -f nodes-pv.yml
kubectl apply -f nodes-pvc.yml
kubectl apply -f storageclass.yml
kubectl apply -f mysql-deployment.yml
kubectl apply -f wordpress-deployment.yml
kubectl apply -f ingress-controller.yml
kubectl apply -f mysql-hpa.yml
kubectl apply -f wordpress-hpa.yml
kubectl apply -f wordpress-ingress.yml
# Wait for deployment to complete
kubectl rollout status deployment/mysql
